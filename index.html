<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>B·∫¢NG THEO D√ïI HO·∫†T ƒê·ªòNG - SALE HUDDLE</title>

  <!-- CDN libs. N·∫øu m·∫°ng n·ªôi b·ªô ch·∫∑n CDN: t·∫£i v·ªÅ v√† thay b·∫±ng ƒë∆∞·ªùng d·∫´n local -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bidv-green:#0b7a6b;
      --bidv-green-dark:#045a4f;
      --bg:#eaf3f1;
      --card:#ffffff;
      --grid:#dfe7e6;
      --text:#14302c;
      --muted:#5b6f6b;
      --shadow:0 6px 18px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color:var(--text);
      background:linear-gradient(180deg, #f3fbf9 0%, var(--bg) 45%, #dfeeed 100%);
    }
    .wrap{max-width:1400px;margin:0 auto;padding:14px 14px 26px}
    .topbar{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 16px;
      display:flex;align-items:center;gap:14px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:280px;}
    .logo{
      width:58px;height:38px;border-radius:10px;
      background:linear-gradient(135deg,var(--bidv-green),var(--bidv-green-dark));
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;letter-spacing:.5px;
    }
    .title{line-height:1.15;}
    .title h1{margin:0;font-size:16px}
    .title div{margin-top:2px;color:var(--muted);font-size:12px}
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;flex:1;
      justify-content:flex-end;
    }
    .control{
      background:#f6fbfa;border:1px solid var(--grid);
      padding:8px 10px;border-radius:12px;
      display:flex;align-items:center;gap:8px;
      min-height:38px;
    }
    .control label{font-size:12px;color:var(--muted);white-space:nowrap}
    .control input[type="file"]{font-size:12px;max-width:260px;}
    select{
      border:1px solid var(--grid);
      background:#fff;
      padding:6px 10px;border-radius:10px;
      font-size:12px;outline:none;
      min-width:170px;
    }
    .pill{
      background:var(--bidv-green);
      color:#fff;border-radius:999px;
      padding:6px 10px;font-size:12px;font-weight:700;
      white-space:nowrap;
    }
    .card{
      margin-top:12px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:10px 10px 12px;
    }
    .hint{
      padding:8px 10px;
      background:#f6fbfa;
      border:1px dashed #bcd9d4;
      border-radius:12px;
      color:var(--muted);
      font-size:12px;
      margin:8px 2px 10px;
    }
    .actions{
      display:flex;gap:10px;justify-content:center;flex-wrap:wrap;
      margin-top:10px;
    }
    .btn{
      border:none;cursor:pointer;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      font-size:13px;
      display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
    }
    .btn.green{background:var(--bidv-green);color:#fff}
    .btn.gray{background:#e8efee;color:#173a34}
    .btn.yellow{background:#f2c94c;color:#2c2c2c}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .table-wrap{
      width:100%;
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--grid);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:1100px;
    }
    thead th{
      position:sticky;top:0;z-index:5;
      background:var(--bidv-green-dark);
      color:#fff;
      font-size:12px;
      padding:10px 8px;
      border-bottom:1px solid #0d6b60;
      text-align:center;
      white-space:nowrap;
    }
    thead tr.sub th{
      top:38px;
      background:var(--bidv-green);
      border-bottom:1px solid #0d6b60;
      font-weight:700;
      padding:8px 6px;
    }
    th.sticky-col, td.sticky-col{
      position:sticky;left:0;z-index:6;
      background:#0b6b5f;
      color:#ffffff;
      text-align:left;
      min-width:320px;
      max-width:420px;
    }
    thead tr.sub th.sticky-col{background:#0b6b5f;}

    /* ‚úÖ FIX ‚ÄúCH·ªÆ TR·∫ÆNG TR√äN N·ªÄN TR·∫ÆNG‚Äù: √©p ch·ªØ tbody v·ªÅ m√†u ƒë·∫≠m */
    tbody td{ color:#14302c; }

    tbody td{
      border-bottom:1px solid var(--grid);
      border-right:1px solid var(--grid);
      padding:8px 6px;
      font-size:12px;
      text-align:center;
      white-space:nowrap;
    }
    tbody td:first-child{border-right:1px solid #0d6b60;}
    tbody tr:nth-child(even) td{background:#fbfefd}
    tbody tr:hover td{background:#f1fbf8}

    .metric{font-weight:700;line-height:1.2;}
    .metric .code{opacity:.95;font-weight:900;display:inline-block;margin-right:8px;}
    .metric .name{opacity:.95;}
    .cell-dual{font-variant-numeric: tabular-nums;}
    .muted{color:var(--muted)}
    .pct{
      font-weight:800;border-radius:10px;padding:5px 8px;
      display:inline-block;min-width:66px;
    }
    .pct.green{background:#e9fbef;color:#0b7a2a;border:1px solid #b9f0c8}
    .pct.yellow{background:#fff7df;color:#9a6b00;border:1px solid #ffe1a3}
    .pct.red{background:#ffe9e9;color:#b32020;border:1px solid #ffc2c2}

    .footerbar{
      margin-top:10px;
      display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;
      color:var(--muted);font-size:12px;padding:0 4px;
    }
    .badge{
      background:#f0f7f6;border:1px solid var(--grid);
      border-radius:999px;padding:4px 10px;
    }

/* ========= FIX HI·ªÇN TH·ªä CH·ªÆ (TR√ÅNH TR·∫ÆNG TR√äN TR·∫ÆNG) ========= */

/* 1) M·∫∑c ƒë·ªãnh: t·∫•t c·∫£ √¥ trong tbody ch·ªØ m√†u ƒë·∫≠m */
#reportTable tbody td{
  color: #14302c !important;
}

/* 2) Ch·ªâ ri√™ng c·ªôt sticky (Ho·∫°t ƒë·ªông) m·ªõi ch·ªØ tr·∫Øng tr√™n n·ªÅn xanh */
#reportTable tbody td.sticky-col,
#reportTable thead th.sticky-col{
  color: #ffffff !important;
  background: #0b6b5f !important;
}

/* 3) Hover: c√°c √¥ th∆∞·ªùng ƒë·ªïi n·ªÅn nh·∫°t nh∆∞ng ch·ªØ v·∫´n ƒë·∫≠m */
#reportTable tbody tr:hover td{
  background: #f1fbf8 !important;
  color: #14302c !important;
}

/* 4) Hover: gi·ªØ nguy√™n c·ªôt sticky n·ªÅn xanh v√† ch·ªØ tr·∫Øng */
#reportTable tbody tr:hover td.sticky-col{
  background: #0b6b5f !important;
  color: #ffffff !important;
}

/* 5) Hover: badge % v·∫´n gi·ªØ m√†u */
#reportTable tbody tr:hover td .pct.green{ color:#0b7a2a !important; }
#reportTable tbody tr:hover td .pct.yellow{ color:#9a6b00 !important; }
#reportTable tbody tr:hover td .pct.red{ color:#b32020 !important; }


  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">BIDV</div>
        <div class="title">
          <h1>B·∫¢NG THEO D√ïI HO·∫†T ƒê·ªòNG ‚Äì SALE HUDDLE</h1>
          <div id="subtitle">Ch·ªçn file Excel ƒë·ªÉ hi·ªÉn th·ªã</div>
        </div>
      </div>

      <div class="controls">
        <div class="control">
          <label>File d·ªØ li·ªáu:</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls"/>
        </div>

        <div class="control">
          <label>Ph√≤ng ban:</label>
          <select id="selPhong">
            <option value="__ALL__">T·∫•t c·∫£</option>
          </select>
        </div>

        <div class="control">
          <label>Ch·∫ø ƒë·ªô xem:</label>
          <select id="selView">
            <option value="PHONG">T·ªïng ph√≤ng</option>
            <option value="CANBO">Chi ti·∫øt c√°n b·ªô</option>
          </select>
        </div>

        <div class="pill" id="weekPill">‚Äî</div>
      </div>
    </div>

    <div class="card">
    <div style="height:6px"></div>
      <div id="tableArea" class="table-wrap" style="display:none;">
        <div id="captureArea">
          <table id="reportTable">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="actions">
        <button class="btn green" id="btnRender" disabled>üîÑ D·ª±ng b·∫£ng</button>
        <button class="btn gray" id="btnExcel" disabled>‚¨áÔ∏è Export Excel</button>
        <button class="btn yellow" id="btnPDF" disabled>üßæ Export PDF</button>
      </div>

      <div class="footerbar">
        <div class="badge" id="statRows">Rows: ‚Äî</div>
        <div class="badge" id="statUnits">Units: ‚Äî</div>
        <div class="badge" id="statUpdated">Updated: ‚Äî</div>
      </div>
    </div>
  </div>

<script>
/************************************
 * MAP T√äN CH·ªà TI√äU HU (tu·ª≥ ch·ªânh theo CN)
 ************************************/
const HU_NAME = {
  HU1:  "S·ªë kh√°ch h√†ng t∆∞∆°ng t√°c",
  HU2:  "S·ªë kh√°ch h√†ng tr√¨nh b√†y s·∫£n ph·∫©m",
  HU3:  "S·ªë kh√°ch h√†ng b√°n th√†nh c√¥ng",
  HU4:  "S·ªë s·∫£n ph·∫©m b√°n th√†nh c√¥ng",
  HU5:  "D∆∞ n·ª£ ph√°t sinh trong k·ª≥ (T·ª∑ ƒë·ªìng)",
  HU6:  "HƒêV ph√°t sinh trong k·ª≥ (T·ª∑ ƒë·ªìng)",
  HU7:  "Th·∫ª t√≠n d·ª•ng m·ªõi (Th·∫ª)",
  HU8:  "Doanh s·ªë b·∫£o hi·ªÉm (BHNT, BHPNT) (Tri·ªáu ƒë·ªìng)",
  HU9:  "Doanh s·ªë s·∫£n ph·∫©m ƒë·∫ßu t∆∞ (Tri·ªáu ƒë·ªìng)",
  HU10: "Thu ph√≠ TK s·ªë ƒë·∫πp (Tri·ªáu ƒë·ªìng)",
  HU11: "Doanh s·ªë CTQT (Tri·ªáu ƒë·ªìng)"
};

/************************************
 * BI·∫æN CHUNG
 ************************************/
let RAW = [];
let METRIC_COLS = [];
let BRANCH_NAME = '';
let CURRENT_WEEK_PILL = '';
let FILE_NAME = '';

const el = (id)=>document.getElementById(id);

const REQUIRED_COLS = [
  'M√£ chi nh√°nh','T√™n chi nh√°nh','M√£ ph√≤ng','T√™n ph√≤ng','M√£ c√°n b·ªô','T√™n c√°n b·ªô','Ti√™u ch√≠'
];

// mapping ti√™u ch√≠ -> key
const TIEUCHI_KEYS = {
  'K·∫ø ho·∫°ch th√°ng': 'KH_THANG',
  'Th·ª±c hi·ªán th√°ng': 'TH_THANG',
  'Ho√†n th√†nh th√°ng (%)': 'HT_THANG',

  'K·∫ø ho·∫°ch tu·∫ßn': 'KH_TUAN',
  'Th·ª±c hi·ªán tu·∫ßn': 'TH_TUAN',
  'Ho√†n th√†nh tu·∫ßn (%)': 'HT_TUAN',

  'K·∫ø ho·∫°ch ng√†y': 'KH_NGAY',
  'Th·ª±c hi·ªán ng√†y': 'TH_NGAY',
  'Ho√†n th√†nh ng√†y (%)': 'HT_NGAY'
};

/************************************
 * UTIL
 ************************************/
function normalizeKey(k){
  return String(k)
    .replace(/\u00A0/g,' ')   // NBSP -> space
    .replace(/\s+/g,' ')     // nhi·ªÅu space -> 1
    .trim();
}
function normalizeRowKeys(row){
  const out = {};
  for(const k of Object.keys(row)){
    out[normalizeKey(k)] = row[k];
  }
  return out;
}
function safeNum(v){
  if(v === null || v === undefined || v === '') return null;
  if(typeof v === 'number') return v;
  const s = String(v).trim().replaceAll('.','').replaceAll(',','.');
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function fmtNumber(n){
  if(n === null || n === undefined) return '‚Äî';
  return new Intl.NumberFormat('vi-VN', { maximumFractionDigits: 2 }).format(n);
}
function fmtDual(th, kh){
  if(th === null && kh === null) return '‚Äî';
  if(th === null) return `‚Äî / ${fmtNumber(kh)}`;
  if(kh === null) return `${fmtNumber(th)} / ‚Äî`;
  return `${fmtNumber(th)} / ${fmtNumber(kh)}`;
}
function pctClass(p){
  if(p === null) return 'yellow';
  if(p >= 100) return 'green';
  if(p >= 80) return 'yellow';
  return 'red';
}
function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

/************************************
 * ƒê·ªåC EXCEL
 ************************************/
function readExcel(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const sheetName = wb.SheetNames.find(n => String(n).toLowerCase() === 'data') || wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(ws, {defval: null});
        resolve({sheetName, rows: json});
      }catch(err){ reject(err); }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

/************************************
 * X√ÅC ƒê·ªäNH C·ªòT CH·ªà TI√äU THEO HEADER TH·ª∞C T·∫æ (fix l·ªách do HƒêV chen gi·ªØa HU6-HU7)
 * - ∆Øu ti√™n ƒë√∫ng th·ª© t·ª± theo ·∫£nh: HU1..HU6, HƒêV tƒÉng m·ªõi, HƒêV quay v√≤ng, HU7..HU11
 ************************************/
function validateHeader(sampleRow){
  const keys = Object.keys(sampleRow).map(normalizeKey);

  const missing = REQUIRED_COLS.filter(c => !keys.includes(c));
  if(missing.length){
    alert('Thi·∫øu c·ªôt b·∫Øt bu·ªôc: ' + missing.join(', '));
    return false;
  }

  // 1) D√≤ c·ªôt HU theo m√£ (nh·∫≠n "HU2" ho·∫∑c "HU2 - ...")
  const huMap = new Map(); // huNumber -> headerKey
  for(const k of keys){
    const m = k.match(/^HU(\d+)\b/i);
    if(m){
      const num = parseInt(m[1], 10);
      if(!huMap.has(num)) huMap.set(num, k);
    }
  }

  // 2) D√≤ 2 c·ªôt chen gi·ªØa (c√≥ th·ªÉ kh√°c hoa/th∆∞·ªùng, c√≥ (T·ª∑ ƒë·ªìng))
  const colHDV_TANG = keys.find(k => /^HƒêV\s*tƒÉng\s*m·ªõi\b/i.test(k)) || null;
  const colHDV_QUAY = keys.find(k => /^HƒêV\s*quay\s*v√≤ng\b/i.test(k)) || null;

  // 3) Build METRIC_COLS theo th·ª© t·ª± mong mu·ªën (d·ª±a tr√™n ·∫£nh)
  METRIC_COLS = [];

  // HU1..HU6
  for(let i=1;i<=6;i++){
    if(huMap.has(i)) METRIC_COLS.push(huMap.get(i));
  }
  // ch√®n 2 c·ªôt HƒêV
  if(colHDV_TANG) METRIC_COLS.push(colHDV_TANG);
  if(colHDV_QUAY) METRIC_COLS.push(colHDV_QUAY);
  // HU7..HU50 (n·∫øu file c√≥ nhi·ªÅu h∆°n 11 th√¨ v·∫´n ƒÉn)
  const huNums = Array.from(huMap.keys()).sort((a,b)=>a-b);
  for(const n of huNums){
    if(n>=7) METRIC_COLS.push(huMap.get(n));
  }

  if(METRIC_COLS.length === 0){
    alert('Kh√¥ng t√¨m th·∫•y c·ªôt ch·ªâ ti√™u (HU/HƒêV) trong file Excel.');
    return false;
  }
  return true;
}

/************************************
 * NH√ÉN CH·ªà TI√äU
 ************************************/
function metricLabelFromHeader(h){
  const raw = normalizeKey(h);
  const hu = raw.match(/^(HU\d+)\b/i);
  if(hu){
    const code = hu[1].toUpperCase();
    // n·∫øu header c√≥ "HU2 - ..." th√¨ l·∫•y ph·∫ßn sau d·∫•u "-"
    const m = raw.match(/^(HU\d+)\s*-\s*(.*)$/i);
    const nameFromExcel = m ? (m[2]||'').trim() : '';
    return { code, name: HU_NAME[code] || nameFromExcel || raw };
  }
  // kh√¥ng ph·∫£i HU (v√≠ d·ª• HƒêV tƒÉng m·ªõi / quay v√≤ng)
  return { code: raw, name: raw };
}

/************************************
 * DROPDOWN PH√íNG BAN
 ************************************/
function buildLookups(){
  const phongSet = new Set();
  for(const r of RAW){
    if(r['T√™n ph√≤ng']) phongSet.add(String(r['T√™n ph√≤ng']).trim());
  }
  const phongs = Array.from(phongSet).sort((a,b)=>a.localeCompare(b,'vi'));
  el('selPhong').innerHTML = '<option value="__ALL__">T·∫•t c·∫£</option>' + phongs.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');

  el('subtitle').textContent = `ƒêang m·ªü: ${FILE_NAME} | Sheet: Data | Ch·ªâ ti√™u: ${METRIC_COLS.length}`;
  el('weekPill').textContent = CURRENT_WEEK_PILL || '‚Äî';

  el('statRows').textContent = `Rows: ${RAW.length}`;
  el('statUpdated').textContent = `Updated: ${new Date().toLocaleString('vi-VN')}`;
}

/************************************
 * AGG
 ************************************/
function aggregate(){
  const view = el('selView').value; // PHONG | CANBO
  const selectedPhong = el('selPhong').value;

  const filtered = RAW.filter(r=>{
    if(selectedPhong === '__ALL__') return true;
    return String(r['T√™n ph√≤ng']||'').trim() === selectedPhong;
  });

  // units
  const unitMap = new Map();
  for(const r of filtered){
    let key, label;
    if(view === 'PHONG'){
      key = String(r['T√™n ph√≤ng']||'').trim();
      label = key || '‚Äî';
    }else{
      const cb = String(r['T√™n c√°n b·ªô']||'').trim();
      const ma = String(r['M√£ c√°n b·ªô']||'').trim();
      key = (ma && ma !== 'null') ? `${ma} - ${cb}` : cb;
      label = key || '‚Äî';
    }
    if(key) unitMap.set(key, label);
  }

  let units = Array.from(unitMap.entries()).map(([key,label])=>({key,label}));
  units.sort((a,b)=>{
    if(a.label === 'T·ªïng') return -1;
    if(b.label === 'T·ªïng') return 1;
    return a.label.localeCompare(b.label,'vi');
  });

  // matrix
  const matrix = {};
  for(const m of METRIC_COLS){
    matrix[m] = {};
    for(const u of units){
      matrix[m][u.key] = {
        TH_THANG:null, KH_THANG:null,
        TH_TUAN:null,  KH_TUAN:null, HT_TUAN:null,
        TH_NGAY:null,  KH_NGAY:null
      };
    }
  }

  for(const r of filtered){
    const tc = String(r['Ti√™u ch√≠']||'').trim();
    const k = TIEUCHI_KEYS[tc];
    if(!k) continue;

    let unitKey;
    if(view === 'PHONG'){
      unitKey = String(r['T√™n ph√≤ng']||'').trim();
    }else{
      const cb = String(r['T√™n c√°n b·ªô']||'').trim();
      const ma = String(r['M√£ c√°n b·ªô']||'').trim();
      unitKey = (ma && ma !== 'null') ? `${ma} - ${cb}` : cb;
    }
    if(!unitKey || !units.find(u=>u.key===unitKey)) continue;

    for(const m of METRIC_COLS){
      const val = safeNum(r[m]);
      if(val === null) continue;

      if(k === 'KH_THANG') matrix[m][unitKey].KH_THANG = val;
      if(k === 'TH_THANG') matrix[m][unitKey].TH_THANG = val;

      if(k === 'KH_TUAN')  matrix[m][unitKey].KH_TUAN  = val;
      if(k === 'TH_TUAN')  matrix[m][unitKey].TH_TUAN  = val;
      if(k === 'HT_TUAN')  matrix[m][unitKey].HT_TUAN  = val;

      if(k === 'KH_NGAY')  matrix[m][unitKey].KH_NGAY  = val;
      if(k === 'TH_NGAY')  matrix[m][unitKey].TH_NGAY  = val;
    }
  }

  // compute HT_TUAN if missing
  for(const m of METRIC_COLS){
    for(const u of units){
      const cell = matrix[m][u.key];
      if(cell.HT_TUAN === null && cell.TH_TUAN !== null && cell.KH_TUAN !== null && cell.KH_TUAN !== 0){
        cell.HT_TUAN = (cell.TH_TUAN / cell.KH_TUAN) * 100;
      }
    }
  }

  return {units, matrix};
}

/************************************
 * RENDER
 ************************************/
function render(){
  const {units, matrix} = aggregate();

  const thead = el('thead');
  const topRow = [];
  const subRow = [];

  topRow.push(`<th class="sticky-col" rowspan="2">Ho·∫°t ƒë·ªông</th>`);
  for(const u of units){
    topRow.push(`<th colspan="4">${escapeHtml(u.label)}</th>`);
    subRow.push(`<th>Th√°ng</th>`);
    subRow.push(`<th>Tu·∫ßn</th>`);
    subRow.push(`<th>% HT Tu·∫ßn</th>`);
    subRow.push(`<th>Ng√†y</th>`);
  }

  thead.innerHTML = `
    <tr>${topRow.join('')}</tr>
    <tr class="sub">${subRow.join('')}</tr>
  `;

  const tbody = el('tbody');
  const rows = [];

  for(const m of METRIC_COLS){
    const ml = metricLabelFromHeader(m);

    const left = `
      <td class="sticky-col">
        <div class="metric">
          <span class="code">${escapeHtml(ml.code)}</span>
          <span class="name">${escapeHtml(ml.name)}</span>
        </div>
      </td>
    `;

    const cells = [];
    for(const u of units){
      const c = matrix[m][u.key];

      const thang = `<span class="cell-dual">${fmtDual(c.TH_THANG, c.KH_THANG)}</span>`;
      const tuan  = `<span class="cell-dual">${fmtDual(c.TH_TUAN,  c.KH_TUAN)}</span>`;

      const pctVal = (c.HT_TUAN===null)? null : c.HT_TUAN;
      const pctTxt = (pctVal===null)? '‚Äî' : `${fmtNumber(pctVal)}%`;
      const pctCls = pctClass(pctVal);

      const ngay  = `<span class="cell-dual">${fmtDual(c.TH_NGAY,  c.KH_NGAY)}</span>`;

      cells.push(`<td>${thang}</td>`);
      cells.push(`<td>${tuan}</td>`);
      cells.push(`<td><span class="pct ${pctCls}">${pctTxt}</span></td>`);
      cells.push(`<td>${ngay}</td>`);
    }

    rows.push(`<tr>${left}${cells.join('')}</tr>`);
  }

  tbody.innerHTML = rows.join('');
  el('tableArea').style.display = 'block';
  el('statUnits').textContent = `Units: ${units.length}`;
}

/************************************
 * EXPORT
 ************************************/
function tableToAoA(){
  const table = el('reportTable');
  const aoa = [];
  for(const tr of table.rows){
    const row = [];
    for(const cell of tr.cells){
      row.push(cell.innerText.replace(/\s+/g,' ').trim());
    }
    aoa.push(row);
  }
  return aoa;
}
async function exportExcel(){
  const aoa = tableToAoA();
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  XLSX.utils.book_append_sheet(wb, ws, 'Dashboard');
  const fn = `Dashboard_${(BRANCH_NAME||'SaleHuddle').replaceAll(' ','_')}.xlsx`;
  XLSX.writeFile(wb, fn);
}
async function exportPDF(){
  const cap = el('captureArea');
  const canvas = await html2canvas(cap, {scale: 2, backgroundColor: '#ffffff', useCORS: true});
  const imgData = canvas.toDataURL('image/png');

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l', 'pt', 'a4');
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();

  const imgW = pageW;
  const imgH = canvas.height * (imgW / canvas.width);

  let y = 0;
  let remaining = imgH;

  pdf.addImage(imgData, 'PNG', 0, 0, imgW, imgH);
  remaining -= pageH;

  while(remaining > 0){
    y -= pageH;
    pdf.addPage();
    pdf.addImage(imgData, 'PNG', 0, y, imgW, imgH);
    remaining -= pageH;
  }

  const fn = `Dashboard_${(BRANCH_NAME||'SaleHuddle').replaceAll(' ','_')}.pdf`;
  pdf.save(fn);
}

/************************************
 * EVENTS
 ************************************/
el('fileInput').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  FILE_NAME = file.name;

  try{
    const {rows} = await readExcel(file);
    if(!rows || rows.length === 0){
      alert('Sheet Data kh√¥ng c√≥ d·ªØ li·ªáu.');
      return;
    }

    RAW = rows.map(normalizeRowKeys);

    if(!validateHeader(RAW[0])) return;

    const bn = RAW.find(r=>r['T√™n chi nh√°nh'] && String(r['T√™n chi nh√°nh']).trim() !== '')?.['T√™n chi nh√°nh'];
    BRANCH_NAME = bn ? String(bn).trim() : '';

    // l·∫•y ng√†y t·ª´ t√™n file n·∫øu c√≥ ddmmyyyy
    const m = FILE_NAME.match(/(\d{2})(\d{2})(\d{4})/);
    CURRENT_WEEK_PILL = m ? `DATE: ${m[1]}/${m[2]}/${m[3]}` : '‚Äî';

    buildLookups();

    el('btnRender').disabled = false;
    el('btnExcel').disabled = false;
    el('btnPDF').disabled = false;

  }catch(err){
    console.error(err);
    alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng .xlsx v√† sheet Data.');
  }
});

el('btnRender').addEventListener('click', render);
el('selPhong').addEventListener('change', ()=>{ if(RAW.length) render(); });
el('selView').addEventListener('change', ()=>{ if(RAW.length) render(); });

el('btnExcel').addEventListener('click', exportExcel);
el('btnPDF').addEventListener('click', exportPDF);
</script>
</body>
</html>
