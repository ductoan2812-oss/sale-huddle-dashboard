<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sale Huddle Dashboard (Apps Script JSONP)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#eef6f5}
  .bar{background:#fff;padding:12px 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .btn{border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn.green{background:#0b7a6b;color:#fff}
  .pill{background:#0b7a6b;color:#fff;border-radius:999px;padding:6px 10px;font-weight:700}
  .wrap{max-width:1400px;margin:0 auto;padding:14px}
  .table-wrap{background:#fff;border-radius:12px;border:1px solid #dfe7e6;overflow:auto}
  table{border-collapse:separate;border-spacing:0;min-width:1100px;width:100%}
  thead th{position:sticky;top:0;background:#045a4f;color:#fff;padding:10px 8px;font-size:12px;white-space:nowrap;z-index:5}
  thead tr.sub th{top:38px;background:#0b7a6b}
  th.sticky-col,td.sticky-col{position:sticky;left:0;z-index:6;background:#0b6b5f;color:#fff;text-align:left;min-width:320px}
  tbody td{border-bottom:1px solid #dfe7e6;border-right:1px solid #dfe7e6;padding:8px 6px;font-size:12px;text-align:center;white-space:nowrap;color:#14302c}
  tbody tr:nth-child(even) td{background:#fbfefd}
  tbody tr:hover td{background:#f1fbf8;color:#14302c}
  tbody tr:hover td.sticky-col{background:#0b6b5f;color:#fff}
  .pct{font-weight:800;border-radius:10px;padding:5px 8px;display:inline-block;min-width:66px}
  .pct.green{background:#e9fbef;color:#0b7a2a;border:1px solid #b9f0c8}
  .pct.yellow{background:#fff7df;color:#9a6b00;border:1px solid #ffe1a3}
  .pct.red{background:#ffe9e9;color:#b32020;border:1px solid #ffc2c2}
  .small{font-size:12px;color:#4b615d}
</style>
</head>
<body>
<div class="bar">
  <button class="btn green" id="btnReload">↻ Tải lại dữ liệu</button>
  <span class="pill" id="status">Đang tải...</span>
  <span class="small" id="meta"></span>
</div>

<div class="wrap">
  <div class="table-wrap">
    <table id="reportTable">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
/** ✅ URL Web App /exec của anh */
const API_EXEC = "https://script.google.com/macros/s/AKfycbyLceE-LHDyCByu_kZLKo7OMtz7gxhKnVCjTtnJE9-iMzK02As_yP4QtUUs4VxJ2V6F/exec";

/* Map tên HU */
const HU_NAME = {
  HU1:"Số khách hàng tương tác",
  HU2:"Số khách hàng trình bày sản phẩm",
  HU3:"Số khách hàng bán thành công",
  HU4:"Số sản phẩm bán thành công",
  HU5:"Dư nợ phát sinh trong kỳ (Tỷ đồng)",
  HU6:"HĐV phát sinh trong kỳ (Tỷ đồng)",
  HU7:"Thẻ tín dụng mới (Thẻ)",
  HU8:"Doanh số bảo hiểm (Triệu đồng)",
  HU9:"Doanh số sản phẩm đầu tư (Triệu đồng)",
  HU10:"Thu phí TK số đẹp (Triệu đồng)",
  HU11:"Doanh số CTQT (Triệu đồng)"
};

const REQUIRED_COLS = ['Mã chi nhánh','Tên chi nhánh','Mã phòng','Tên phòng','Mã cán bộ','Tên cán bộ','Tiêu chí'];
const TIEUCHI_KEYS = {
  'Kế hoạch tháng':'KH_THANG','Thực hiện tháng':'TH_THANG','Hoàn thành tháng (%)':'HT_THANG',
  'Kế hoạch tuần':'KH_TUAN','Thực hiện tuần':'TH_TUAN','Hoàn thành tuần (%)':'HT_TUAN',
  'Kế hoạch ngày':'KH_NGAY','Thực hiện ngày':'TH_NGAY','Hoàn thành ngày (%)':'HT_NGAY'
};

let RAW = [];
let METRIC_COLS = [];

const el = id => document.getElementById(id);

function normalizeKey(k){ return String(k).replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim(); }
function safeNum(v){
  if(v===null||v===undefined||v==='') return null;
  if(typeof v==='number') return v;
  const s = String(v).trim().replaceAll('.','').replaceAll(',','.');
  const n = Number(s);
  return Number.isFinite(n)?n:null;
}
function fmtNumber(n){ if(n==null) return '—'; return new Intl.NumberFormat('vi-VN',{maximumFractionDigits:2}).format(n); }
function fmtDual(th,kh){
  if(th==null && kh==null) return '—';
  if(th==null) return `— / ${fmtNumber(kh)}`;
  if(kh==null) return `${fmtNumber(th)} / —`;
  return `${fmtNumber(th)} / ${fmtNumber(kh)}`;
}
function pctClass(p){ if(p==null) return 'yellow'; if(p>=100) return 'green'; if(p>=80) return 'yellow'; return 'red'; }
function escapeHtml(s){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
}
function metricLabel(h){
  const raw = normalizeKey(h);
  const m = raw.match(/^(HU\d+)\b/i);
  if(m){
    const code = m[1].toUpperCase();
    return {code, name: HU_NAME[code] || raw};
  }
  return {code: raw, name: raw};
}

function validateHeader(headers){
  const keys = headers.map(normalizeKey);
  const missing = REQUIRED_COLS.filter(c => !keys.includes(c));
  if(missing.length) throw new Error('Thiếu cột: ' + missing.join(', '));

  const huMap = new Map();
  for(const k of keys){
    const m = k.match(/^HU(\d+)\b/i);
    if(m){
      const num = parseInt(m[1],10);
      if(!huMap.has(num)) huMap.set(num,k);
    }
  }
  const colHDV_TANG = keys.find(k => /^HĐV\s*tăng\s*mới\b/i.test(k)) || null;
  const colHDV_QUAY = keys.find(k => /^HĐV\s*quay\s*vòng\b/i.test(k)) || null;

  METRIC_COLS = [];
  for(let i=1;i<=6;i++){ if(huMap.has(i)) METRIC_COLS.push(huMap.get(i)); }
  if(colHDV_TANG) METRIC_COLS.push(colHDV_TANG);
  if(colHDV_QUAY) METRIC_COLS.push(colHDV_QUAY);

  const huNums = Array.from(huMap.keys()).sort((a,b)=>a-b);
  for(const n of huNums){ if(n>=7) METRIC_COLS.push(huMap.get(n)); }

  if(METRIC_COLS.length===0) throw new Error('Không tìm thấy cột chỉ tiêu.');
}

function aggregate(){
  const unitSet = new Set(RAW.map(r=>String(r['Tên phòng']||'').trim()).filter(Boolean));
  const units = Array.from(unitSet).sort((a,b)=>a.localeCompare(b,'vi')).map(x=>({key:x,label:x}));

  const matrix = {};
  for(const m of METRIC_COLS){
    matrix[m] = {};
    for(const u of units){
      matrix[m][u.key] = {TH_THANG:null,KH_THANG:null,TH_TUAN:null,KH_TUAN:null,HT_TUAN:null,TH_NGAY:null,KH_NGAY:null};
    }
  }

  for(const r of RAW){
    const tc = String(r['Tiêu chí']||'').trim();
    const k = TIEUCHI_KEYS[tc];
    if(!k) continue;

    const unitKey = String(r['Tên phòng']||'').trim();
    if(!unitKey) continue;

    for(const m of METRIC_COLS){
      const val = safeNum(r[m]);
      if(val==null) continue;

      if(k==='KH_THANG') matrix[m][unitKey].KH_THANG = val;
      if(k==='TH_THANG') matrix[m][unitKey].TH_THANG = val;
      if(k==='KH_TUAN') matrix[m][unitKey].KH_TUAN = val;
      if(k==='TH_TUAN') matrix[m][unitKey].TH_TUAN = val;
      if(k==='HT_TUAN') matrix[m][unitKey].HT_TUAN = val;
      if(k==='KH_NGAY') matrix[m][unitKey].KH_NGAY = val;
      if(k==='TH_NGAY') matrix[m][unitKey].TH_NGAY = val;
    }
  }

  for(const m of METRIC_COLS){
    for(const u of units){
      const c = matrix[m][u.key];
      if(c.HT_TUAN==null && c.TH_TUAN!=null && c.KH_TUAN!=null && c.KH_TUAN!==0){
        c.HT_TUAN = (c.TH_TUAN/c.KH_TUAN)*100;
      }
    }
  }

  return {units,matrix};
}

function render(){
  const {units,matrix} = aggregate();

  const topRow = [`<th class="sticky-col" rowspan="2">Hoạt động</th>`];
  const subRow = [];
  for(const u of units){
    topRow.push(`<th colspan="4">${escapeHtml(u.label)}</th>`);
    subRow.push(`<th>Tháng</th><th>Tuần</th><th>% HT Tuần</th><th>Ngày</th>`);
  }
  el('thead').innerHTML = `<tr>${topRow.join('')}</tr><tr class="sub">${subRow.join('')}</tr>`;

  const rows = [];
  for(const m of METRIC_COLS){
    const ml = metricLabel(m);
    const left = `<td class="sticky-col"><b>${escapeHtml(ml.code)}</b> ${escapeHtml(ml.name)}</td>`;
    const cells = [];
    for(const u of units){
      const c = matrix[m][u.key];
      const pctVal = c.HT_TUAN==null?null:c.HT_TUAN;
      cells.push(`<td>${fmtDual(c.TH_THANG,c.KH_THANG)}</td>`);
      cells.push(`<td>${fmtDual(c.TH_TUAN,c.KH_TUAN)}</td>`);
      cells.push(`<td><span class="pct ${pctClass(pctVal)}">${pctVal==null?'—':fmtNumber(pctVal)+'%'}</span></td>`);
      cells.push(`<td>${fmtDual(c.TH_NGAY,c.KH_NGAY)}</td>`);
    }
    rows.push(`<tr>${left}${cells.join('')}</tr>`);
  }
  el('tbody').innerHTML = rows.join('');
}

/** ===== JSONP loader (né CORS) ===== */
function loadJsonp(url){
  return new Promise((resolve, reject) => {
    const cbName = "jsonp_cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const timeout = setTimeout(() => {
      cleanup();
      reject(new Error("JSONP timeout"));
    }, 20000);

    function cleanup(){
      clearTimeout(timeout);
      script.remove();
      delete window[cbName];
    }

    window[cbName] = (data) => {
      cleanup();
      resolve(data);
    };

    script.onerror = () => {
      cleanup();
      reject(new Error("JSONP load error"));
    };

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + encodeURIComponent(cbName) + "&_=" + Date.now();
    document.head.appendChild(script);
  });
}

async function loadFromApi(){
  el('status').textContent = "Đang tải...";

  try{
    const data = await loadJsonp(API_EXEC); // JSONP gọi thẳng /exec
    if(!data.ok) throw new Error(data.error || "API ok=false");

    const headers = data.headers.map(normalizeKey);
    validateHeader(headers);

    RAW = data.rows.map(r=>{
      const obj = {};
      for(const k of Object.keys(r)) obj[normalizeKey(k)] = r[k];
      return obj;
    });

    render();
    const branch = RAW.find(r => r['Tên chi nhánh'] && String(r['Tên chi nhánh']).trim())?.['Tên chi nhánh'] || '';
    el('meta').textContent = `${branch ? ('Chi nhánh: '+branch+' | ') : ''}Rows: ${RAW.length} | Updated: ${new Date().toLocaleString('vi-VN')}`;
    el('status').textContent = "Đã tải";
  }catch(err){
    console.error(err);
    el('status').textContent = "Lỗi tải";
    alert("Không tải được dữ liệu (JSONP).\n" +
          "Nếu mạng nội bộ chặn script.google.com thì vẫn sẽ lỗi.\n\n" +
          "Chi tiết: " + (err.message || err));
  }
}

document.getElementById("btnReload").addEventListener("click", loadFromApi);
loadFromApi();
</script>
</body>
</html>
